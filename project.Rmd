---
title: "Project 2"
author: "Luke Terry"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    csl: biomed-central.csl
    df_print: paged
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    number_sections: yes
    theme: journal
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: 4
  pdf_document:
    df_print: kable
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    highlight: tango
    toc: yes
    toc_depth: 4
bibliography: project.bib
abstract: This project is all about applications of SLR to real data using R
---

<center>

![Luke Terry](me.jpg "My Picture"){ width=20% }

</center>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(leaflet)
library(dplyr)
```

# My Video

```{r}
# <video width="320" height="240" controls>
#   <source src="usingvideoinrmd.mp4" type="video/mp4">
# Your browser does not support the video tag.
# </video>
```




# Introduction

Baseball is a timeless sport which was popularized in the United States in the mid 1850s (@Wikipedia2021). Like many other sports in the United States, watching baseball, talking about baseball, and making predictions about baseball is a popular pastime among many people.

Compared to other sports, baseball and statistics have a close relationship. Perhaps it's something about the leisurely pace of a baseball game, or the easily measurable individual actions in each baseball play. Many people believe that the use of statistics in baseball was introduced by Billy Beane, the General Manager of the Oakland A's, since this narrative was popularized in Michael Lewis's 2003 book *Moneyball* (@Moneyball), and 2011 movie of the same name. Statistics in baseball, however, have been a consideration within coaching staff far before Billy Beane. There exist evidence of statisticians assisting baseball managers as early as 1940, and many general managers used statistical analysis to inform their decisions prior to Beane, such as Danny Evans of the Dodgers and Doug Melvin of the Brewers. Beane's fascination with OBP was not a new development either. Sandy Alderson rebuilt the A's strategy around OBP two decades before Billy Beane ever managed the A's (@NumbersGame).

There even exists a special term for the art of analyzing baseball statistics: sabermetrics. It was coined by Bill James, and influential statistician in the field, and its name refers to SABR, and acronym for the society of american baseball research (@NumbersGame)

## What are the variables? 

Each experimental unit in this case is one pitcher, or rather how one pitcher performed over the course of the 2019 season.

There are several statistics which are calculated based on each pitchers performance. These include traditional statistics, like Earned Run Average (ERA), Wins, and Losses, but I've also added a column for the hits a pitcher gives up per out they earn.

Each player is identified in the table by a playerID which is unique to them (believe it or not, there are several MLB players with the same name as other players throughout history).

The variables which I am interested in are any quantitative statistics of a pitcher, and the amount of hits per out they give up, a quantitative measure. I intend to find out which statistics (if any) predict the rate at which a pitcher gives up hits.

```{r pitcherTable}
library(Lahman)

ptall <- Lahman::Pitching
pt <- subset(ptall, ptall$yearID == 2019) #subset the data so that only 2019 data is analyzed


pt <- subset(pt, pt$G >= 30) #remove inexperienced or one-off pitchers

pt$HPO <- pt$H/pt$IPouts #add hits per out column

library(DT)
datatable(subset(pt, select = c("playerID", "teamID", "ERA", "W", "L", "HPO")))

#add statcast data to pt --------------------------------------------------------

stc <- read.csv("data/statcast_pitching_data.csv")
#for some reason different baseball databases use different playerIDS
#There was no direct crosswalk between the Lahman database and Statcast, so I had to make it myself.
#The script which does this is in the idCrosswalkTable.R file.
cw <- readRDS("data/crosswalk.RDS")

#initialize vector for new column
velocity <- c()
spin_rate <- c()
release_extension <- c()
xba <- c()
eff_min_vel <- c()
babip <- c()


#add statcast data to Lahman pitcher data frame.
for (i in pt$playerID){
  #iterate over every pitcher, get their stats
  mlbID <- cw[which(cw == i),2]
  playerStats <- stc[which(stc$player_id == mlbID),]
  
  #add stats to column vectors
  velocity <- c(velocity, playerStats$velocity)
  spin_rate <- c(spin_rate, playerStats$spin_rate)
  release_extension <- c(release_extension, playerStats$release_extension)
  xba <- c(xba, playerStats$xba)
  eff_min_vel <- c(eff_min_vel, playerStats$eff_min_vel)
  babip <- c(babip, playerStats$babip)

}

#add new columnds to pt
pt <- cbind(pt, velocity)
pt <- cbind(pt, spin_rate)
pt <- cbind(pt, release_extension)
pt <- cbind(pt, xba)
pt <- cbind(pt, eff_min_vel)
pt <- cbind(pt, babip)
```

### Plot data

```{r carcharacteristics, fig.height = 5, fig.cap = "MTCARS",fig.align='center',fig.cap="Graph of data with loess smoother"}
# library(ggplot2)
# g = ggplot(mtcars, aes(x = disp, y = mpg, color = cyl)) + geom_point()
# g = g + geom_smooth(method = "loess")
# g
```


## How were the data collected? 

Luckily for me, baseball's extra close relationship with statistical scrutiny means that copious amounts of reliable sabermetric data are available from various sources online, free of charge.

The specific data which I am using is a nearly exhaustive record of traditional baseball statistics compiled by Sean Lahman, called the Lahman Database(@Lahman). The data set contains standard batting and pitching statistics, for every player, by year, since 1871, although for the sake of brevity, my analysis will focus on the 2019 regular MLB season. Specifically, I intend to use linear regression to isolate factors which affect the rate at which pitchers give up hits.

The database was compiled from various sources by a team of volunteers, since it dates back to 1871. The season that I will focus on however (2019), was likely scraped from mlb.com since major league baseball now offers statistics in that online format.

The data itself, however, was collected by a combination of volunteers and mlb staff. 

## Why was it gathered? 

At its core, the data here was gathered to help mlb coaches and team administrations make informed decisions. The ubiquity and accuracy of sabermetrics, however, have allowed the media to take a real interest in baseball statistics.

## What is your interest in the data?

My personal interest in the data does not, however, lie in making informed decisions or predictions of overall baseball games. Each year, the MLB runs a competition called Beat the Streak. The rules are simple: each day, you are allowed to pick one or two batters who you think will get a hit that particular day. For each of your batters, if they get a hit, your streak goes up by 1. If they have an at bat, but fail to get a hit, your streak resets to 0. If you get a streak of 57 during the regular season, you win 5.6 million dollars (@bts). 

Obviously, this is a difficult challenge to achieve. The probability of winning it big follows a binomial distribution, with a probability of getting a hit equal to the probability that the chosen batter gets a hit in a day. The probability that a chosen batter gets a hit in a day ostensibly follows a binomial distribution, where the probabilty of a success in each Bernoulli trial is the players batting average, and the number of trials is the number of at bats the player is likely to get based on their position in the batting lineup. Below is a histogram of the seasonal batting averages for all major league players. To remove potential outliers, only players with more than 30 at bats in a season are on this histogram.

```{r}
library(ggplot2)
bt <- Lahman::battingStats() #initialize batting data

#create histogram
bt <- subset(bt, bt$AB > 30)
g = ggplot(bt, aes(x=BA))
g = g + geom_histogram(fill = "#a62919", binwidth = .1)
g = g + xlab("Batting Averages")
g = g + ylab("Frequency")
g = g + ggtitle("Distribution of Seasonal Major League Batting Averages")
g
```

As you can see, it will be difficult to predict with certainty that a player gets a hit in a day. The average batting average for this historical dataset is 0.239. You can pick players with high batting averages, of course, but those players may not always get many plate appearances, and their batting averages don't get *that* much higher. For instance, the all time high batting average in this data set is still only 0.512. (The batting average is from Rudy Penderton's 1996 season with the Red Sox)

If we assume that a player as good as Rudy Penderton can be chosen everyday (which is a generous assumption), and we assume that this player gets 4 plate appearances per game (which is the average amount that most places in the order will get, especially when players who have a higher batting average are chosen @PA), then the probability of a hit is about 94%^[This is because the probability for getting a hit that day follows a binomial distribution with 4 trials, and a probability of the batting average for each trial (0.512 in Penderton's case). The R command used to find this answer is 1-dbinom(0,4,0.512)].

Although this is a high probability, we have to keep in mind that we don't just want to predict whether a player will get a hit in a day, we want to predict whether a player will get a hit in a day *57 times in a row*. Thus if we were able to pick Rudy Penderton every day, the probability of attaining a 57 day streak is 0.00203, or about 1 in 500 ^[This is because the probability of choosing 57 correct days in a row can be estimated with the geometric distribution, with 1- ~94% (or ~6%) as the probability, and 57 as the number of failures before 1 "success" (or in this case day without a hit) occurs. The R command used to find this answer is dgeom(57,1-pb), where pb is an object containint the exact probability of Penderton getting a hit in a day as calculated in the previous paragraph.].

This answer, however, assumes that each hit is a totally independent trial, where the only factor at play is the player's batting average. In reality, there are many factors which affect a baseball players ability to get hits. Conventional knowledge dictates that the pitcher which a batter is facing is the most important factor that dictates a player's ability to get a hit (apart from the players themselves). Because of this, this analysis will focus on what factors may cause a pitcher to give up more hits.

### Include pictures `![](jpeg)`

# Premliminary Plots and Interpretation of the data

In order to decide which variables to analyze using linear regression, it's useful to make preliminary plots and analyze them subjectively for seemingly linear patterns. Below are a few which I've constructed using some traditional pitching statistics. All graphs are a plot of a traditional pitching statistic versus a pitcher's Hits Per Out.

```{r echo = FALSE, warning=FALSE}
library(ggplot2)
library(patchwork)

createLowessForHPO <- function(column, xvar){
  g <- ggplot(pt, aes(x = column, y = HPO)) + geom_point()
  g = g + geom_smooth(method = "loess")
  #g = g + ggtitle(paste(xvar ," versus Hits given up Per Out"))
  g = g + ggtitle(xvar)
  g = g + xlab(xvar) + ylab("Hits Per Out")
  g
}


a = createLowessForHPO(pt$ERA, "Earned Run Average")

a + b + c + d + e + f + g + h + plot_layout(ncol = 4)
```


```{r eval = FALSE, echo = FALSE}
library(shiny)
library(ggplot2)
library(patchwork)

#only render these plots if in an interactive document type
#if (interactive()){
  
ui <- basicPage(
  plotOutput("LoessPlot"),

  #list input variables
  selectInput(inputId = "x", label = "X Variable:", choices = c("Wins" = "W","Earned Runs" = "ER", "Earned Run Average" = "ERA", "Opponents Batting Average" = "BAOpp", "Total Walks Given Up" = "BB", "Strikeouts" = "SO", "Earned Runs" = "ER", "Velocity" = "velocity", "Spin Rate" = "spin_rate", "Release Extension" = "release_extension","Expected Batting Average" = "xba", "Effective Minimum Velocity" = "eff_min_vel", "Batting Average on Balls in Play" = "babip", "Hits Per Out" = "HPO")),
  
  selectInput(inputId = "y", label = "Y Variable:", choices = c("Wins" = "W","Earned Runs" = "ER", "Earned Run Average" = "ERA", "Opponents Batting Average" = "BAOpp", "Total Walks Given Up" = "BB", "Strikeouts" = "SO", "Earned Runs" = "ER", "Velocity" = "velocity", "Spin Rate" = "spin_rate", "Release Extension" = "release_extension","Expected Batting Average" = "xba", "Effective Minimum Velocity" = "eff_min_vel", "Batting Average on Balls in Play" = "babip", "Hits Per Out" = "HPO")),

#input for minimum number of pitches
 sliderInput("mp", "Minimum number of Games for each pitcher",
    min = 0, max = 50, value = 30, step = 1)
  
)

server <- function(input, output) {
  output$LoessPlot <- renderPlot({
    
  #subset pt based on minimum number of pitches
  pt <- subset(pt, pt$G >= input$mp)
    
  g <- ggplot(data = pt, aes_string(x = input$x, y = input$y)) + geom_point()
  g = g + ggtitle(input$x)
  g = g + geom_smooth(method = "loess")

  g
  })

}

shinyApp(ui, server)

#}
```

As you can see, there are a few factors that seem to have some association with the Hits Per Out that a pitcher gives up. The amount of batters faced by a pitcher (per out) seems to have an association, but the loess line is more curve than I was hoping for. Opponent's batting average seems to have some kind of curved association, and ERA seems to have a very straight association, but doing an analysis on either of these two variables would be uninteresting, since the statistics are dimensionally equal. For instance, a pitcher's ERA is equal to the number of runs the pitcher gives up per nine innings. Since hits earn runs, of course a higher number of hits is going to correspond to a higher number of runs.

Fortunately for me, baseball research and statistics have tied in more statistical measurements in the recent past. Through an MLB service called Statcast (@CITATIONNEEDED), it is possible to analyze more uncommon measures of a pitcher's tendencies.

```{r}



#make new plots
# createLowessForHPO(pt$velocity, "Velocity")
# createLowessForHPO(pt$spin_rate, "Spin Rate")
# createLowessForHPO(pt$release_extension, "Release Extension")
# createLowessForHPO(pt$xba, "Exp. Batting Average")
# createLowessForHPO(pt$eff_min_vel, "Effective Velocity Differential")
# createLowessForHPO(pt$babip, "BABIP")






```


# Theory needed to carry out SLR

## Main result 1


## Main result 2
## Main result 3 etc

# Validity with mathematical expressions


The following function was taken from [https://rpubs.com/therimalaya/43190](https://rpubs.com/therimalaya/43190)

## Checks on validity

### Straight trend line  

#### Use trendscatter

### Errors distributed Normally

$$\epsilon_i \sim N(0,\sigma^2)$$



#### Shapiro-wilk

### Constant variance

#### Residual vs fitted values

#### trendscatter on Residual Vs Fitted

### Zero mean value of $\epsilon$

### Independence of data 

# Model selection if you compared models 

## Use adjusted $R^2$ 
$$R_{adj}^2 =$$



# Analysis of the data

## Make sure you include many great plots

## Add the trend to the data


## Summary lm object

### Interpretation of all tests
### Interpretation of multiple R squared
### Interpretation of all point estimates
## Calculate cis for $\beta$ parameter estimates
### Use of `predict()`
### Use of `ciReg()`

### Check on outliers using cooks plots

Remember to interpret this plot and all other plots



# Conclusion
## Answer your research question
## Suggest ways to improve model or experiment


# References
  
